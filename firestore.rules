rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- RBAC HELPER FUNCTIONS ---
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // Fetch the user's role from the 'users' collection
    // Note: In production, Custom Claims are recommended for performance/cost, 
    // but reading the doc is suitable for this implementation phase.
    function getUserRoles() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles;
    }
    
    function hasPermission(permission) {
      // Admin has all permissions (wildcard check)
      return isSignedIn() && (
        "admin" in getUserRoles() || 
        // Moderator Permissions
        (permission == "moderation.manage_content" && "moderator" in getUserRoles()) ||
        (permission == "moderation.view_queue" && "moderator" in getUserRoles()) ||
        // Teacher Permissions
        (permission == "courses.manage" && "teacher" in getUserRoles()) ||
        (permission == "content.create" && "teacher" in getUserRoles()) ||
        // Faculty Permissions
        (permission == "faculty.edit" && ("admin" in getUserRoles() || "moderator" in getUserRoles())) ||
        (permission == "faculty.rate" && ("teacher" in getUserRoles() || "student" in getUserRoles())) ||
        // Student Permissions
        (permission == "submissions.create" && "student" in getUserRoles())
      );
    }

    // Role Hierarchies (Simpler check if we trust the role string directly)
    function isAdmin() {
      return isSignedIn() && "admin" in getUserRoles(); // Assuming roles is an array
    }
    
    function isTeacher() {
      return isSignedIn() && ("teacher" in getUserRoles() || isAdmin());
    }

    // --- COLLECTION RULES ---

    // Users: Admin can manage all; Users can view/edit own
    match /users/{userId} {
      allow read: if isSignedIn(); // public view (restricted data shown by app logic)
      allow update: if isOwner(userId) || isAdmin(); // "users.manage"
      allow create: if isSignedIn(); // Registration
      // Prevent privilege escalation: User cannot assign roles unless they are admin
      // This requires complex validation of the 'roles' field in the incoming data
      // For now, relying on Admin check for updates covering most cases.
    }

    // Courses
    match /courses/{courseId} {
      allow read: if isSignedIn(); // "courses.view"
      allow create: if isTeacher(); // "courses.manage"
      allow update: if isTeacher() && resource.data.ownerId == request.auth.uid; // Own course
      allow delete: if isTeacher() && resource.data.ownerId == request.auth.uid; // Own course
    }
    
    // Content / Materials
    match /content/{contentId} {
       allow read: if isSignedIn();
       allow create: if isTeacher(); // "content.create"
       allow update, delete: if isTeacher() && resource.data.ownerId == request.auth.uid;
    }

    // Submissions (Grades)
    match /submissions/{submissionId} {
      allow read: if isOwner(resource.data.studentId) || isTeacher(); // "analytics.view_personal" vs "submissions.grade"
      allow create: if isSignedIn(); // "submissions.create" (Students)
      allow update: if isTeacher(); // Grading
    }

    // Moderation Queue
    match /moderation_queue/{itemId} {
      allow read, write: if isSignedIn() && ("moderator" in getUserRoles() || isAdmin());
    }
    
    // Faculty (Profiles, Ratings)
    match /faculty/{facultyId} {
        allow read: if isSignedIn();
        allow update, delete, create: if hasPermission("faculty.edit"); // Admin/Mod
        
        // Ratings Sub-collection
        match /ratings/{ratingId} {
            // Rate permission needed to create/update own rating
            allow create: if hasPermission("faculty.rate");
            allow update: if hasPermission("faculty.rate") && resource.data.userId == request.auth.uid;
            allow read: if isSignedIn();
        }
    }

    // System Logs
    match /system_logs/{logId} {
      allow read: if isAdmin();
      allow write: if isAdmin(); // System writes usually bypass rules via Admin SDK, but this secures client access
    }

    // Legacy/Existing Rules (preserved/adapted)
    match /usernames/{username} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
    }

    match /servers/{serverId} {
       allow read: if isSignedIn();
       allow create: if isSignedIn();
       allow update: if isAdmin(); 
        match /channels/{channelId} {
             allow read: if isSignedIn();
             allow write: if isAdmin();
             match /messages/{messageId} {
                 allow read: if isSignedIn();
                 allow create: if isSignedIn();
                 allow update, delete: if isOwner(resource.data.authorId) || isAdmin();
             }
        }
    }

  }
}
